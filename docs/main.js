(()=>{"use strict";function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var e=256,i=240,n=function(){function n(t){if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,n),void 0===window.requestAnimationFrame)return window.alert("use a brower that supports requestAnimationFrame method"),!1;this.canvas=t,this.ctx=t.getContext("2d"),this.ctx_multiple=1,this.width=e,this.height=i,this.ImageData=this.ctx.createImageData(this.width,this.height),this.uint32=new Uint32Array(61440),this.resizeCanvas()}var s,r;return s=n,(r=[{key:"initCanvas",value:function(){if(!this.ctx)return!1;this.ImageData=this.ctx.createImageData(this.canvas.width,this.canvas.height);for(var t=0;t<i;t++)for(var n=0;n<e;n++)this.renderPixel(n,t,160);return this.updateScreen(),!0}},{key:"resizeCanvas",value:function(){console.log("at resizeCanvas, this.width is ",this.width);var t=Math.floor(.9*window.innerWidth/this.width);this.ctx_multiple!=t&&(console.log("previous canvas size ".concat(this.width,", current windows width(x0.9)= ").concat(.9*window.innerWidth)),console.log("change magnification to ".concat(t)),this.ctx_multiple=t>=1?t:1),this.canvas.width=e*this.ctx_multiple,this.canvas.height=i*this.ctx_multiple,this.canvas.style.width=e*this.ctx_multiple,this.canvas.style.height=i*this.ctx_multiple,this.initCanvas()}},{key:"renderPixel",value:function(t,e,i){var n=e*this.width+t;this.uint32[n]=i}},{key:"_getCanvasColor",value:function(t){var e=new Uint8Array(4);return e[0]=(16711680&t)>>16,e[1]=(65280&t)>>8,e[2]=255&t,e[3]=255,e}},{key:"updateScreen",value:function(){var t=new Uint8Array(4);if(1===this.ctx_multiple)for(var n=0;n<this.canvas.width*this.canvas.height*4;n+=4)t=this._getCanvasColor(this.uint32[n/4]),this.ImageData.data[n]=t[0],this.ImageData.data[n+1]=t[1],this.ImageData.data[n+2]=t[2],this.ImageData.data[n+3]=t[3];else if(this.ctx_multiple>1)for(var s=0;s<i;s++)for(var r=0;r<e;r++){t=this._getCanvasColor(this.uint32[s/4]),t=this._getCanvasColor(this.uint32[s*e+r]);for(var c=0;c<this.ctx_multiple;c++)for(var o=0;o<this.ctx_multiple;o++){var a=4*((s*this.ctx_multiple+c)*this.canvas.width+(r*this.ctx_multiple+o));this.ImageData.data[a]=t[0],this.ImageData.data[a+1]=t[1],this.ImageData.data[a+2]=t[2],this.ImageData.data[a+3]=t[3]}}this.ctx.putImageData(this.ImageData,0,0)}}])&&t(s.prototype,r),Object.defineProperty(s,"prototype",{writable:!1}),n}();function s(t,e){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=t.toString(16),s="";if(t<0&&(s+="-"),!0!==i&&(s+="0x"),void 0===e)return s+n;for(var r="",c=0;c<e;c++)r+="0";return s+(r+n).substr(-1*e)}function r(t){return t<16?"0"+t.toString(16).toUpperCase():t.toString(16).toUpperCase()}var c=function(t){return r(t)},o=function(t,e,i){return s(t,e,i)};function a(t){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},a(t)}function u(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&l(t,e)}function l(t,e){return l=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},l(t,e)}function d(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var i,n=p(t);if(e){var s=p(this).constructor;i=Reflect.construct(n,arguments,s)}else i=n.apply(this,arguments);return h(this,i)}}function h(t,e){if(e&&("object"===a(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function p(t){return p=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},p(t)}function y(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function m(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function f(t,e,i){return e&&m(t.prototype,e),i&&m(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}var E=function(){function t(e){y(this,t),2===e?(this.isRegister16bit=!0,this.type=2,this.data=new Uint16Array(1)):(this.isRegister8bit=!0,this.type=1,this.data=new Uint8Array(1)),this.clear()}return f(t,[{key:"getWidth",value:function(){return 8*this.data.byteLength}},{key:"load",value:function(){return this.data[0]}},{key:"loadBit",value:function(t){return this.data[0]>>t&1}},{key:"loadBits",value:function(t,e){return this.data[0]>>t&(1<<e)-1}},{key:"store",value:function(t){this.data[0]=t}},{key:"storeBit",value:function(t,e){e&=1,this.data[0]=this.data[0]&~(1<<t)|e<<t}},{key:"storeBits",value:function(t,e,i){var n=(1<<e)-1;i&=n,this.data[0]=this.data[0]&~(n<<t)|i<<t}},{key:"clear",value:function(){this.data[0]=0}},{key:"setBit",value:function(t){this.storeBit(t,1)}},{key:"clearBit",value:function(t){this.storeBit(t,0)}},{key:"isBitSet",value:function(t){return 1===this.loadBit(t)}},{key:"increment",value:function(){this.data[0]++}},{key:"incrementBy2",value:function(){this.data[0]+=2}},{key:"add",value:function(t){this.data[0]+=t}},{key:"decrement",value:function(){this.data[0]--}},{key:"decrementBy2",value:function(){this.data[0]-=2}},{key:"sub",value:function(t){this.data[0]-=t}},{key:"shift",value:function(t){t&=1;var e=this.loadBit(this.getWidth()-1);return this.data[0]=this.data[0]<<1|t,e}},{key:"dump",value:function(){if(1===this.type)return c(this.data[0]);if(2===this.type){var t="";return(t+=c(this.data[0]>>8&255))+c(255&this.data[0])}return""}}]),t}(),I=function(t){u(i,t);var e=d(i);function i(){var t;return y(this,i),(t=e.call(this,1)).isRegister8bit=!0,t}return f(i)}(E),_=function(t){u(i,t);var e=d(i);function i(){var t;return y(this,i),(t=e.call(this,2)).isRegister16bit=!0,t.bytes=new Uint8Array(t.data.buffer),t}return f(i,[{key:"loadHigherByte",value:function(){return this.bytes[1]}},{key:"loadLowerByte",value:function(){return this.bytes[0]}},{key:"storeHigherByte",value:function(t){this.bytes[1]=t}},{key:"storeLowerByte",value:function(t){this.bytes[0]=t}}]),i}(E);function v(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var A=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.isMemory=!0,this.data=new Uint8Array(e)}var e,i;return e=t,(i=[{key:"clear",value:function(){for(var t=0,e=this.getCapacity();t<e;t++)this.storeWithoutMapping(t,0)}},{key:"getCapacity",value:function(){return this.data.byteLength}},{key:"load",value:function(t){return this.data[t]}},{key:"load2Byte",value:function(t){return this.data[t+1]<<8|this.data[t]}},{key:"loadWithoutMapping",value:function(t){return this.data[t]}},{key:"store",value:function(t,e){return!(t>this.getCapacity()||(this.data[t]=e,0))}},{key:"storeWithoutMapping",value:function(t,e){this.data[t]=e}},{key:"dump",value:function(){for(var t="",e=!1,i=this.getCapacity(),n=0;n<i;n++){if(n%16==0){if(e){for(var s=!1;this._checkNext16BytesIsZero(n+16,i);)n+=16,s=!0;s&&(t+="...\n")}t+=o(n-0,4)+" ",e=!0}var r=this.load(n);t+=o(r,2,!0)+" ",0!=r&&(e=!1),n%16==15&&(t+="\n")}return t}},{key:"_checkNext16BytesIsZero",value:function(t,e){if(t+16>=e)return!1;for(var i=0,n=t;n<t+16;n++)i+=this.load(n);return 0==i}}])&&v(e.prototype,i),Object.defineProperty(e,"prototype",{writable:!1}),t}(),b={id:0,addr:65530},k={id:1,addr:65532},R=2,T={id:3,addr:65534},S={INV:{id:0,name:"inv"},ADC:{id:1,name:"adc"},AND:{id:2,name:"and"},ASL:{id:3,name:"asl"},BCC:{id:4,name:"bcc"},BCS:{id:5,name:"bcs"},BEQ:{id:6,name:"beq"},BIT:{id:7,name:"bit"},BMI:{id:8,name:"bmi"},BNE:{id:9,name:"bne"},BPL:{id:10,name:"bpl"},BRK:{id:11,name:"brk"},BVC:{id:12,name:"bvc"},BVS:{id:13,name:"bvs"},CLC:{id:14,name:"clc"},CLD:{id:15,name:"cld"},CLI:{id:16,name:"cli"},CLV:{id:17,name:"clv"},CMP:{id:18,name:"cmp"},CPX:{id:19,name:"cpx"},CPY:{id:20,name:"cpy"},DEC:{id:21,name:"dec"},DEX:{id:22,name:"dex"},DEY:{id:23,name:"dey"},EOR:{id:24,name:"eor"},INC:{id:25,name:"inc"},INX:{id:26,name:"inx"},INY:{id:27,name:"iny"},JMP:{id:28,name:"jmp"},JSR:{id:29,name:"jsr"},LDA:{id:30,name:"lda"},LDX:{id:31,name:"ldx"},LDY:{id:32,name:"ldy"},LSR:{id:33,name:"lsr"},NOP:{id:34,name:"nop"},ORA:{id:35,name:"ora"},PHA:{id:36,name:"pha"},PHP:{id:37,name:"php"},PLA:{id:38,name:"pla"},PLP:{id:39,name:"plp"},ROL:{id:40,name:"rol"},ROR:{id:41,name:"ror"},RTI:{id:42,name:"rti"},RTS:{id:43,name:"rts"},SBC:{id:44,name:"sbc"},SEC:{id:45,name:"sec"},SED:{id:46,name:"sed"},SEI:{id:47,name:"sei"},STA:{id:48,name:"sta"},STX:{id:49,name:"stx"},STY:{id:50,name:"sty"},TAX:{id:51,name:"tax"},TAY:{id:52,name:"tay"},TSX:{id:53,name:"tsx"},TXA:{id:54,name:"txa"},TXS:{id:55,name:"txs"},TYA:{id:56,name:"tya"}},D={IMMEDIATE:{id:0,pc:2,name:"immediate"},ABSOLUTE:{id:1,pc:3,name:"absolute"},INDEXED_ABSOLUTE_X:{id:2,pc:3,name:"indexed_absolute_x"},INDEXED_ABSOLUTE_Y:{id:3,pc:3,name:"indexed_absolute_y"},ZERO_PAGE:{id:4,pc:2,name:"zero_page"},INDEXED_ZERO_PAGE_X:{id:5,pc:2,name:"indexed_zero_page_x"},INDEXED_ZERO_PAGE_Y:{id:6,pc:2,name:"indexed_zero_page_y"},IMPLIED:{id:7,pc:1,name:"implied"},ACCUMULATOR:{id:8,pc:1,name:"accumulator"},INDIRECT:{id:9,pc:3,name:"indirect"},INDEXED_INDIRECT_X:{id:10,pc:2,name:"indexed_indirect_x"},INDEXED_INDIRECT_Y:{id:11,pc:2,name:"indexed_indirect_y"},RELATIVE:{id:12,pc:2,name:"relative"}},B={0:{instruction:S.BRK,cycle:7,mode:D.IMPLIED},1:{instruction:S.ORA,cycle:6,mode:D.INDEXED_INDIRECT_X},2:{instruction:S.INV,cycle:0,mode:null},3:{instruction:S.INV,cycle:0,mode:null},4:{instruction:S.INV,cycle:0,mode:null},5:{instruction:S.ORA,cycle:3,mode:D.ZERO_PAGE},6:{instruction:S.ASL,cycle:5,mode:D.ZERO_PAGE},7:{instruction:S.INV,cycle:0,mode:null},8:{instruction:S.PHP,cycle:3,mode:D.IMPLIED},9:{instruction:S.ORA,cycle:2,mode:D.IMMEDIATE},10:{instruction:S.ASL,cycle:2,mode:D.ACCUMULATOR},11:{instruction:S.INV,cycle:0,mode:null},12:{instruction:S.INV,cycle:0,mode:null},13:{instruction:S.ORA,cycle:4,mode:D.ABSOLUTE},14:{instruction:S.ASL,cycle:6,mode:D.ABSOLUTE},15:{instruction:S.INV,cycle:0,mode:null},16:{instruction:S.BPL,cycle:2,mode:D.RELATIVE},17:{instruction:S.ORA,cycle:5,mode:D.INDEXED_INDIRECT_Y},18:{instruction:S.INV,cycle:0,mode:null},19:{instruction:S.INV,cycle:0,mode:null},20:{instruction:S.INV,cycle:0,mode:null},21:{instruction:S.ORA,cycle:4,mode:D.INDEXED_ZERO_PAGE_X},22:{instruction:S.ASL,cycle:6,mode:D.INDEXED_ZERO_PAGE_X},23:{instruction:S.INV,cycle:0,mode:null},24:{instruction:S.CLC,cycle:2,mode:D.IMPLIED},25:{instruction:S.ORA,cycle:4,mode:D.INDEXED_ABSOLUTE_Y},26:{instruction:S.INV,cycle:0,mode:null},27:{instruction:S.INV,cycle:0,mode:null},28:{instruction:S.INV,cycle:0,mode:null},29:{instruction:S.ORA,cycle:4,mode:D.INDEXED_ABSOLUTE_X},30:{instruction:S.ASL,cycle:7,mode:D.INDEXED_ABSOLUTE_X},31:{instruction:S.INV,cycle:0,mode:null},32:{instruction:S.JSR,cycle:0,mode:D.ABSOLUTE},33:{instruction:S.AND,cycle:6,mode:D.INDEXED_INDIRECT_X},34:{instruction:S.INV,cycle:0,mode:null},35:{instruction:S.INV,cycle:0,mode:null},36:{instruction:S.BIT,cycle:3,mode:D.ZERO_PAGE},37:{instruction:S.AND,cycle:3,mode:D.ZERO_PAGE},38:{instruction:S.ROL,cycle:5,mode:D.ZERO_PAGE},39:{instruction:S.INV,cycle:0,mode:null},40:{instruction:S.PLP,cycle:4,mode:D.IMPLIED},41:{instruction:S.AND,cycle:2,mode:D.IMMEDIATE},42:{instruction:S.ROL,cycle:2,mode:D.ACCUMULATOR},43:{instruction:S.INV,cycle:0,mode:null},44:{instruction:S.BIT,cycle:4,mode:D.ABSOLUTE},45:{instruction:S.AND,cycle:4,mode:D.ABSOLUTE},46:{instruction:S.ROL,cycle:6,mode:D.ABSOLUTE},47:{instruction:S.INV,cycle:0,mode:null},48:{instruction:S.BMI,cycle:2,mode:D.RELATIVE},49:{instruction:S.AND,cycle:5,mode:D.INDEXED_INDIRECT_Y},50:{instruction:S.INV,cycle:0,mode:null},51:{instruction:S.INV,cycle:0,mode:null},52:{instruction:S.INV,cycle:0,mode:null},53:{instruction:S.AND,cycle:4,mode:D.INDEXED_ZERO_PAGE_X},54:{instruction:S.ROL,cycle:6,mode:D.INDEXED_ZERO_PAGE_X},55:{instruction:S.INV,cycle:0,mode:null},56:{instruction:S.SEC,cycle:2,mode:D.IMPLIED},57:{instruction:S.AND,cycle:4,mode:D.INDEXED_ABSOLUTE_Y},58:{instruction:S.INV,cycle:0,mode:null},59:{instruction:S.INV,cycle:0,mode:null},60:{instruction:S.INV,cycle:0,mode:null},61:{instruction:S.AND,cycle:4,mode:D.INDEXED_ABSOLUTE_X},62:{instruction:S.ROL,cycle:7,mode:D.INDEXED_ABSOLUTE_X},63:{instruction:S.INV,cycle:0,mode:null},64:{instruction:S.RTI,cycle:6,mode:D.IMPLIED},65:{instruction:S.EOR,cycle:6,mode:D.INDEXED_INDIRECT_X},66:{instruction:S.INV,cycle:0,mode:null},67:{instruction:S.INV,cycle:0,mode:null},68:{instruction:S.INV,cycle:0,mode:null},69:{instruction:S.EOR,cycle:3,mode:D.ZERO_PAGE},70:{instruction:S.LSR,cycle:5,mode:D.ZERO_PAGE},71:{instruction:S.INV,cycle:0,mode:null},72:{instruction:S.PHA,cycle:3,mode:D.IMPLIED},73:{instruction:S.EOR,cycle:2,mode:D.IMMEDIATE},74:{instruction:S.LSR,cycle:2,mode:D.ACCUMULATOR},75:{instruction:S.INV,cycle:0,mode:null},76:{instruction:S.JMP,cycle:0,mode:D.ABSOLUTE},77:{instruction:S.EOR,cycle:4,mode:D.ABSOLUTE},78:{instruction:S.LSR,cycle:6,mode:D.ABSOLUTE},79:{instruction:S.INV,cycle:0,mode:null},80:{instruction:S.BVC,cycle:2,mode:D.RELATIVE},81:{instruction:S.EOR,cycle:5,mode:D.INDEXED_INDIRECT_Y},82:{instruction:S.INV,cycle:0,mode:null},83:{instruction:S.INV,cycle:0,mode:null},84:{instruction:S.INV,cycle:0,mode:null},85:{instruction:S.EOR,cycle:4,mode:D.INDEXED_ZERO_PAGE_X},86:{instruction:S.LSR,cycle:6,mode:D.INDEXED_ZERO_PAGE_X},87:{instruction:S.INV,cycle:0,mode:null},88:{instruction:S.CLI,cycle:2,mode:D.IMPLIED},89:{instruction:S.EOR,cycle:4,mode:D.INDEXED_ABSOLUTE_Y},90:{instruction:S.INV,cycle:0,mode:null},91:{instruction:S.INV,cycle:0,mode:null},92:{instruction:S.INV,cycle:0,mode:null},93:{instruction:S.EOR,cycle:4,mode:D.INDEXED_ABSOLUTE_X},94:{instruction:S.LSR,cycle:7,mode:D.INDEXED_ABSOLUTE_X},95:{instruction:S.INV,cycle:0,mode:null},96:{instruction:S.RTS,cycle:6,mode:D.IMPLIED},97:{instruction:S.ADC,cycle:6,mode:D.INDEXED_INDIRECT_X},98:{instruction:S.INV,cycle:0,mode:null},99:{instruction:S.INV,cycle:0,mode:null},100:{instruction:S.INV,cycle:0,mode:null},101:{instruction:S.ADC,cycle:3,mode:D.ZERO_PAGE},102:{instruction:S.ROR,cycle:5,mode:D.ZERO_PAGE},103:{instruction:S.INV,cycle:0,mode:null},104:{instruction:S.PLA,cycle:4,mode:D.IMPLIED},105:{instruction:S.ADC,cycle:2,mode:D.IMMEDIATE},106:{instruction:S.ROR,cycle:2,mode:D.ACCUMULATOR},107:{instruction:S.INV,cycle:0,mode:null},108:{instruction:S.JMP,cycle:0,mode:D.INDIRECT},109:{instruction:S.ADC,cycle:4,mode:D.ABSOLUTE},110:{instruction:S.ROR,cycle:6,mode:D.ABSOLUTE},111:{instruction:S.INV,cycle:0,mode:null},112:{instruction:S.BVS,cycle:2,mode:D.RELATIVE},113:{instruction:S.ADC,cycle:5,mode:D.INDEXED_INDIRECT_Y},114:{instruction:S.INV,cycle:0,mode:null},115:{instruction:S.INV,cycle:0,mode:null},116:{instruction:S.INV,cycle:0,mode:null},117:{instruction:S.ADC,cycle:4,mode:D.INDEXED_ZERO_PAGE_X},118:{instruction:S.ROR,cycle:6,mode:D.INDEXED_ZERO_PAGE_X},119:{instruction:S.INV,cycle:0,mode:null},120:{instruction:S.SEI,cycle:2,mode:D.IMPLIED},121:{instruction:S.ADC,cycle:4,mode:D.INDEXED_ABSOLUTE_Y},122:{instruction:S.INV,cycle:0,mode:null},123:{instruction:S.INV,cycle:0,mode:null},124:{instruction:S.INV,cycle:0,mode:null},125:{instruction:S.ADC,cycle:4,mode:D.INDEXED_ABSOLUTE_X},126:{instruction:S.ROR,cycle:7,mode:D.INDEXED_ABSOLUTE_X},127:{instruction:S.INV,cycle:0,mode:null},128:{instruction:S.INV,cycle:0,mode:null},129:{instruction:S.STA,cycle:6,mode:D.INDEXED_INDIRECT_X},130:{instruction:S.INV,cycle:0,mode:null},131:{instruction:S.INV,cycle:0,mode:null},132:{instruction:S.STY,cycle:3,mode:D.ZERO_PAGE},133:{instruction:S.STA,cycle:3,mode:D.ZERO_PAGE},134:{instruction:S.STX,cycle:3,mode:D.ZERO_PAGE},135:{instruction:S.INV,cycle:0,mode:null},136:{instruction:S.DEY,cycle:2,mode:D.IMPLIED},137:{instruction:S.INV,cycle:0,mode:null},138:{instruction:S.TXA,cycle:2,mode:D.IMPLIED},139:{instruction:S.INV,cycle:0,mode:null},140:{instruction:S.STY,cycle:4,mode:D.ABSOLUTE},141:{instruction:S.STA,cycle:4,mode:D.ABSOLUTE},142:{instruction:S.STX,cycle:4,mode:D.ABSOLUTE},143:{instruction:S.INV,cycle:0,mode:null},144:{instruction:S.BCC,cycle:2,mode:D.RELATIVE},145:{instruction:S.STA,cycle:6,mode:D.INDEXED_INDIRECT_Y},146:{instruction:S.INV,cycle:0,mode:null},147:{instruction:S.INV,cycle:0,mode:null},148:{instruction:S.STY,cycle:4,mode:D.INDEXED_ZERO_PAGE_X},149:{instruction:S.STA,cycle:4,mode:D.INDEXED_ZERO_PAGE_X},150:{instruction:S.STX,cycle:4,mode:D.INDEXED_ZERO_PAGE_Y},151:{instruction:S.INV,cycle:0,mode:null},152:{instruction:S.TYA,cycle:2,mode:D.IMPLIED},153:{instruction:S.STA,cycle:5,mode:D.INDEXED_ABSOLUTE_Y},154:{instruction:S.TXS,cycle:2,mode:D.IMPLIED},155:{instruction:S.INV,cycle:0,mode:null},156:{instruction:S.INV,cycle:0,mode:null},157:{instruction:S.STA,cycle:5,mode:D.INDEXED_ABSOLUTE_X},158:{instruction:S.INV,cycle:0,mode:null},159:{instruction:S.INV,cycle:0,mode:null},160:{instruction:S.LDY,cycle:2,mode:D.IMMEDIATE},161:{instruction:S.LDA,cycle:6,mode:D.INDEXED_INDIRECT_X},162:{instruction:S.LDX,cycle:2,mode:D.IMMEDIATE},163:{instruction:S.INV,cycle:0,mode:null},164:{instruction:S.LDY,cycle:3,mode:D.ZERO_PAGE},165:{instruction:S.LDA,cycle:3,mode:D.ZERO_PAGE},166:{instruction:S.LDX,cycle:3,mode:D.ZERO_PAGE},167:{instruction:S.INV,cycle:0,mode:null},168:{instruction:S.TAY,cycle:2,mode:D.IMPLIED},169:{instruction:S.LDA,cycle:2,mode:D.IMMEDIATE},170:{instruction:S.TAX,cycle:2,mode:D.IMPLIED},171:{instruction:S.INV,cycle:0,mode:null},172:{instruction:S.LDY,cycle:4,mode:D.ABSOLUTE},173:{instruction:S.LDA,cycle:4,mode:D.ABSOLUTE},174:{instruction:S.LDX,cycle:4,mode:D.ABSOLUTE},175:{instruction:S.INV,cycle:0,mode:null},176:{instruction:S.BCS,cycle:2,mode:D.RELATIVE},177:{instruction:S.LDA,cycle:5,mode:D.INDEXED_INDIRECT_Y},178:{instruction:S.INV,cycle:0,mode:null},179:{instruction:S.INV,cycle:0,mode:null},180:{instruction:S.LDY,cycle:4,mode:D.INDEXED_ZERO_PAGE_X},181:{instruction:S.LDA,cycle:4,mode:D.INDEXED_ZERO_PAGE_X},182:{instruction:S.LDX,cycle:4,mode:D.INDEXED_ZERO_PAGE_Y},183:{instruction:S.INV,cycle:0,mode:null},184:{instruction:S.CLV,cycle:2,mode:D.IMPLIED},185:{instruction:S.LDA,cycle:4,mode:D.INDEXED_ABSOLUTE_Y},186:{instruction:S.TSX,cycle:2,mode:D.IMPLIED},187:{instruction:S.INV,cycle:0,mode:null},188:{instruction:S.LDY,cycle:4,mode:D.INDEXED_ABSOLUTE_X},189:{instruction:S.LDA,cycle:4,mode:D.INDEXED_ABSOLUTE_X},190:{instruction:S.LDX,cycle:4,mode:D.INDEXED_ABSOLUTE_Y},191:{instruction:S.INV,cycle:0,mode:null},192:{instruction:S.CPY,cycle:2,mode:D.IMMEDIATE},193:{instruction:S.CMP,cycle:6,mode:D.INDEXED_INDIRECT_X},194:{instruction:S.INV,cycle:0,mode:null},195:{instruction:S.INV,cycle:0,mode:null},196:{instruction:S.CPY,cycle:3,mode:D.ZERO_PAGE},197:{instruction:S.CMP,cycle:3,mode:D.ZERO_PAGE},198:{instruction:S.DEC,cycle:5,mode:D.ZERO_PAGE},199:{instruction:S.INV,cycle:0,mode:null},200:{instruction:S.INY,cycle:2,mode:D.IMPLIED},201:{instruction:S.CMP,cycle:2,mode:D.IMMEDIATE},202:{instruction:S.DEX,cycle:2,mode:D.IMPLIED},203:{instruction:S.INV,cycle:0,mode:null},204:{instruction:S.CPY,cycle:4,mode:D.ABSOLUTE},205:{instruction:S.CMP,cycle:4,mode:D.ABSOLUTE},206:{instruction:S.DEC,cycle:6,mode:D.ABSOLUTE},207:{instruction:S.INV,cycle:0,mode:null},208:{instruction:S.BNE,cycle:2,mode:D.RELATIVE},209:{instruction:S.CMP,cycle:5,mode:D.INDEXED_INDIRECT_Y},210:{instruction:S.INV,cycle:0,mode:null},211:{instruction:S.INV,cycle:0,mode:null},212:{instruction:S.INV,cycle:0,mode:null},213:{instruction:S.CMP,cycle:4,mode:D.INDEXED_ZERO_PAGE_X},214:{instruction:S.DEC,cycle:6,mode:D.INDEXED_ZERO_PAGE_X},215:{instruction:S.INV,cycle:0,mode:null},216:{instruction:S.CLD,cycle:2,mode:D.IMPLIED},217:{instruction:S.CMP,cycle:4,mode:D.INDEXED_ABSOLUTE_Y},218:{instruction:S.INV,cycle:0,mode:null},219:{instruction:S.INV,cycle:0,mode:null},220:{instruction:S.INV,cycle:0,mode:null},221:{instruction:S.CMP,cycle:4,mode:D.INDEXED_ABSOLUTE_X},222:{instruction:S.DEC,cycle:7,mode:D.INDEXED_ABSOLUTE_X},223:{instruction:S.INV,cycle:0,mode:null},224:{instruction:S.CPX,cycle:2,mode:D.IMMEDIATE},225:{instruction:S.SBC,cycle:6,mode:D.INDEXED_INDIRECT_X},226:{instruction:S.INV,cycle:0,mode:null},227:{instruction:S.INV,cycle:0,mode:null},228:{instruction:S.CPX,cycle:3,mode:D.ZERO_PAGE},229:{instruction:S.SBC,cycle:3,mode:D.ZERO_PAGE},230:{instruction:S.INC,cycle:5,mode:D.ZERO_PAGE},231:{instruction:S.INV,cycle:0,mode:null},232:{instruction:S.INX,cycle:2,mode:D.IMPLIED},233:{instruction:S.SBC,cycle:2,mode:D.IMMEDIATE},234:{instruction:S.NOP,cycle:2,mode:D.IMPLIED},235:{instruction:S.INV,cycle:0,mode:null},236:{instruction:S.CPX,cycle:4,mode:D.ABSOLUTE},237:{instruction:S.SBC,cycle:4,mode:D.ABSOLUTE},238:{instruction:S.INC,cycle:6,mode:D.ABSOLUTE},239:{instruction:S.INV,cycle:0,mode:null},240:{instruction:S.BEQ,cycle:2,mode:D.RELATIVE},241:{instruction:S.SBC,cycle:5,mode:D.INDEXED_INDIRECT_Y},242:{instruction:S.INV,cycle:0,mode:null},243:{instruction:S.INV,cycle:0,mode:null},244:{instruction:S.INV,cycle:0,mode:null},245:{instruction:S.SBC,cycle:4,mode:D.INDEXED_ZERO_PAGE_X},246:{instruction:S.INC,cycle:6,mode:D.INDEXED_ZERO_PAGE_X},247:{instruction:S.INV,cycle:0,mode:null},248:{instruction:S.SED,cycle:2,mode:D.IMPLIED},249:{instruction:S.SBC,cycle:4,mode:D.INDEXED_ABSOLUTE_Y},250:{instruction:S.INV,cycle:0,mode:null},251:{instruction:S.INV,cycle:0,mode:null},252:{instruction:S.INV,cycle:0,mode:null},253:{instruction:S.SBC,cycle:4,mode:D.INDEXED_ABSOLUTE_X},254:{instruction:S.INC,cycle:7,mode:D.INDEXED_ABSOLUTE_X},255:{instruction:S.INV,cycle:0,mode:null}};function N(t){return N="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},N(t)}function L(t,e){return L=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},L(t,e)}function g(t,e){if(e&&("object"===N(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function P(t){return P=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},P(t)}function C(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function O(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function V(t,e,i){return e&&O(t.prototype,e),i&&O(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}var M=function(){function t(e){C(this,t),this.isCpu=!0,this.nes=e,this.rom=null,this.ppu=null,this.pc=new _,this.sp=new I,this.a=new I,this.x=new I,this.y=new I,this.p=new w,this.ram=new A(2048),this.dbg_message=!0}return V(t,[{key:"SetRom",value:function(t){this.rom=t}},{key:"SetPpu",value:function(t){this.ppu=t}},{key:"InitCpu",value:function(){this.p.store(52),this.a.clear(),this.x.clear(),this.y.clear(),this.sp.store(253),this.ram.clear(),this.interrupt(k)}},{key:"runCycle",value:function(){if(!0!==this.isStall()){var t=this.fetch(),e=this.decode(t);this.operate(e,t),this.stallCycle=e.cycle,this.dbg_message&&console.log(this.dump())}this.stallCycle--}},{key:"isStall",value:function(){return this.stallCycle>0}},{key:"interrupt",value:function(t){switch(t.id){case b.id:this.pushStack2Bytes(this.pc.load()),this.pushStack(this.p.load()),this.p.setI(),this.p.clearB();break;case k.id:this.p.setI();break;case R:if(!0===this.p.isI())return;this.pushStack2Bytes(this.pc.load()),this.pushStack(this.p.load()),this.p.setI(),this.p.clearB();break;case T.id:this.pushStack2Bytes(this.pc.load()),this.pushStack(this.p.load()),this.p.setI(),this.p.setB();break;default:return void console.error("Cpu.interrupt is invalid id:"+t.id)}this.pc.store(this.load2Bytes(t.addr))}},{key:"load",value:function(t){return(t&=65535)>=0&&t<8192?this.ram.load(2047&t):t>=8192&&t<16384?this.ppu.loadRegister(8199&t):t>=32768&&t<65536?this.rom.load(t):0}},{key:"load2Bytes",value:function(t){return this.load(t)|this.load(t+1)<<8}},{key:"store",value:function(t,e){var i=65535&t;return i>=0&&i<8192?this.ram.store(2047&i,e):i>=8192&&i<16384?this.ppu.storeRegister(8199&i,e):void 0}},{key:"fetch",value:function(){var t=this.load(this.pc.load());return this.pc.increment(),t}},{key:"decode",value:function(t){return B[t]}},{key:"operate",value:function(t,e){var i=0;switch(t.instruction.id!==S.INV.id&&(i=this.getAddressWithAddressingMode(t)),t.instruction.id){case S.INV.id:console.error("invalid operand");break;case S.LDA.id:this.opLDA(i);break;case S.LDX.id:this.opLDX(i);break;case S.LDY.id:this.opLDY(i);break;case S.STA.id:this.opSTA(i);break;case S.STX.id:this.opSTX(i);break;case S.STY.id:this.opSTY(i);break;case S.TAX.id:this.opTAX();break;case S.TAY.id:this.opTAY();break;case S.TSX.id:this.opTSX();break;case S.TXA.id:this.opTXA();break;case S.TXS.id:this.opTXS();break;case S.TYA.id:this.opTYA();break;case S.ADC.id:this.opADC(i);break;case S.AND.id:this.opAND(i);break;case S.ASL.id:t.mode.id==D.ACCUMULATOR.id?this.a.store(this.opASL_Sub(this.a.load())):this.opASL(i);break;case S.BIT.id:this.opBIT(i);break;case S.CMP.id:this.opCMP(i,this.a.load());break;case S.CPX.id:this.opCMP(i,this.x.load());break;case S.CPY.id:this.opCMP(i,this.y.load());break;case S.DEC.id:this.opDEC(i);break;case S.DEX.id:this.x.store(this.opDEC_Sub(this.x.load()));break;case S.DEY.id:this.y.store(this.opDEC_Sub(this.y.load()));break;case S.EOR.id:this.opEOR(i);break;case S.INC.id:this.opINC(i);break;case S.INX.id:this.x.store(this.opINC_Sub(this.x.load()));break;case S.INY.id:this.y.store(this.opINC_Sub(this.y.load()));break;case S.LSR.id:t.mode.id==D.ACCUMULATOR.id?this.a.store(this.opLSR_Sub(this.a.load())):this.opLSR(i);break;case S.ORA.id:this.opORA(i);break;case S.ROL.id:t.mode.id==D.ACCUMULATOR.id?this.a.store(this.opROL_Sub(this.a.load())):this.opROL(i);break;case S.ROR.id:t.mode.id==D.ACCUMULATOR.id?this.a.store(this.opRROR_Sub(this.a.load())):this.opROR(i);break;case S.SBC.id:this.opSBC(i);break;case S.PHA.id:this.opPHA();break;case S.PHP.id:this.opPHP();break;case S.PLA.id:this.opPLA();break;case S.PLP.id:this.opPLP();break;case S.JMP.id:this.opJMP(i);break;case S.JSR.id:this.opJSR(i);break;case S.RTS.id:this.opRTS();break;case S.RTI.id:this.opRTI();break;case S.BCC.id:this.opBranch(i,!this.p.isC());break;case S.BCS.id:this.opBranch(i,this.p.isC());break;case S.BEQ.id:this.opBranch(i,this.p.isZ());break;case S.BMI.id:this.opBranch(i,this.p.isN());break;case S.BNE.id:this.opBranch(i,!this.p.isZ());break;case S.BPL.id:this.opBranch(i,!this.p.isN());break;case S.BVC.id:this.opBranch(i,!this.p.isV());break;case S.BVS.id:this.opBranch(i,this.p.isV());break;case S.CLC.id:this.p.clearC();break;case S.CLD.id:this.p.clearD();break;case S.CLI.id:this.p.clearI();break;case S.CLV.id:this.p.clearV();break;case S.SEC.id:this.p.setC();break;case S.SED.id:this.p.setD();break;case S.SEI.id:this.p.setI();break;case S.BRK.id:this.opBRK();break;case S.NOP.id:break;default:console.error("Cpu.operand is not implemented yet")}return e}},{key:"getAddressWithAddressingMode",value:function(t){var e;switch(t.mode.id){case D.IMMEDIATE.id:e=this.getAddressImmediate();break;case D.ABSOLUTE.id:e=this.getAddressAbsolute();break;case D.INDEXED_ABSOLUTE_X.id:e=this.getAddressAbsoluteX();break;case D.INDEXED_ABSOLUTE_Y.id:e=this.getAddressAbsoluteY();break;case D.ZERO_PAGE.id:e=this.getAddressZeroPage();break;case D.INDEXED_ZERO_PAGE_X.id:e=this.getAddressZeroPageX();break;case D.INDEXED_ZERO_PAGE_Y.id:e=this.getAddressZeroPageY();break;case D.IMPLIED.id:e=0;break;case D.ACCUMULATOR.id:e=this.a.load();break;case D.INDIRECT.id:e=this.getAddressZeroPage();break;case D.INDEXED_INDIRECT_X.id:e=this.getAddressIndirectX();break;case D.INDEXED_INDIRECT_Y.id:e=this.getAddressIndirectY();break;case D.RELATIVE.id:e=this.getAddressRelative();break;default:throw new Error("Cpu: Unkown addressing mode.")}return e}},{key:"getAddressZeroPage",value:function(){var t=this.load(this.pc.load());return this.pc.increment(),t}},{key:"getAddressImmediate",value:function(){var t=this.pc.load();return this.pc.increment(),t}},{key:"getAddressAbsolute",value:function(){var t=this.load2Bytes(this.pc.load());return this.pc.incrementBy2(),65535&t}},{key:"getAddressZeroPageX",value:function(){return 255&this.getAddressZeroPage()+this.x.load()}},{key:"getAddressZeroPageY",value:function(){return 255&this.getAddressZeroPage()+this.y.load()}},{key:"getAddressIndirectX",value:function(){var t=this.getAddressZeroPage();return t+=this.x.load(),this.load2Bytes(255&t)}},{key:"getAddressIndirectY",value:function(){var t=this.getAddressZeroPage();return 65535&this.load2Bytes(t)+this.y.load()}},{key:"getAddressAbsoluteX",value:function(){return 65535&this.getAddressAbsolute()+this.x.load()}},{key:"getAddressAbsoluteY",value:function(){return 65535&this.getAddressAbsolute()+this.y.load()}},{key:"getAddressRelative",value:function(){var t=this.load(this.pc.load());return this.pc.increment(),128&t&&(t-=256),t}},{key:"updateN",value:function(t){0==(128&t)?this.p.clearN():this.p.setN()}},{key:"updateZ",value:function(t){0==(255&t)?this.p.setZ():this.p.clearZ()}},{key:"updateC",value:function(t){0==(256&t)?this.p.clearC():this.p.setC()}},{key:"getStackAddress",value:function(){return this.sp.load()+256}},{key:"pushStack",value:function(t){this.store(this.getStackAddress(),t),this.sp.decrement()}},{key:"popStack",value:function(){return this.sp.increment(),this.load(this.getStackAddress())}},{key:"pushStack2Bytes",value:function(t){this.store(this.getStackAddress(),t>>8&255),this.sp.decrement(),this.store(this.getStackAddress(),255&t),this.sp.decrement()}},{key:"popStack2Bytes",value:function(){this.sp.increment();var t=this.load(this.getStackAddress());return this.sp.increment(),this.load(this.getStackAddress())<<8|t}},{key:"opLDA",value:function(t){var e=this.load(t);this.a.store(e),this.updateN(e),this.updateZ(e)}},{key:"opLDX",value:function(t){var e=this.load(t);this.x.store(e),this.updateN(e),this.updateZ(e)}},{key:"opLDY",value:function(t){var e=this.load(t);this.y.store(e),this.updateN(e),this.updateZ(e)}},{key:"opSTA",value:function(t){this.store(t,this.a.load())}},{key:"opSTX",value:function(t){this.store(t,this.x.load())}},{key:"opSTY",value:function(t){this.store(t,this.y.load())}},{key:"opTAX",value:function(){var t=this.a.load();this.x.store(t),this.updateN(t),this.updateZ(t)}},{key:"opTAY",value:function(){var t=this.a.load();this.y.store(t),this.updateN(t),this.updateZ(t)}},{key:"opTSX",value:function(){var t=this.s.load();this.x.store(t),this.p.clearN(),this.p.clearZ()}},{key:"opTXA",value:function(){var t=this.x.load();this.a.store(t),this.updateN(t),this.updateZ(t)}},{key:"opTXS",value:function(){this.sp.store(this.x.load())}},{key:"opTYA",value:function(){var t=this.y.load();this.a.store(t),this.updateN(t),this.updateZ(t)}},{key:"opADC",value:function(t){var e=this.a.load(),i=this.load(t),n=e+i+(this.p.isC()?1:0);this.a.store(n),this.updateN(n),this.updateZ(n),this.updateC(n),!(128&(e^i))&&128&(i^n)?this.p.setV():this.p.clearV()}},{key:"opAND",value:function(t){var e=this.a.load()&this.load(t);this.a.store(e),this.updateN(e),this.updateZ(e)}},{key:"opASL_Sub",value:function(t){var e=t<<1;return this.updateN(e),this.updateZ(e),this.updateC(e),255&e}},{key:"opASL",value:function(t){this.store(t,this.opASL_Sub(this.load(t)))}},{key:"opBIT",value:function(t){var e=this.load(t),i=e&this.a.load();this.updateN(e),this.updateZ(i),0==(64&e)?this.p.clearV():this.p.setV()}},{key:"opCMP",value:function(t,e){var i=this.load(t),n=e-i;this.updateN(n),this.updateZ(n),e>=i?this.p.setC():this.p.clearC()}},{key:"opDEC",value:function(t){this.store(t,this.opDEC_Sub(this.load(t)))}},{key:"opDEC_Sub",value:function(t){var e=t-1;return this.updateN(e),this.updateZ(e),255&e}},{key:"opEOR",value:function(t){var e=this.a.load()^this.load(t);this.a.store(e),this.updateN(e),this.updateZ(e)}},{key:"opINC",value:function(t){this.store(t,this.opINC_Sub(this.load(t)))}},{key:"opINC_Sub",value:function(t){var e=t+1;return this.updateN(e),this.updateZ(e),255&e}},{key:"opLSR_Sub",value:function(t){var e=t>>1;return this.p.clearN(),this.updateZ(e),0==(1&t)?this.p.clearC():this.p.setC(),255&e}},{key:"opLSR",value:function(t){this.store(t,this.opLSR_Sub(this.load(t)))}},{key:"opORA",value:function(t){var e=this.a.load()|this.load(t);this.a.store(e),this.updateN(e),this.updateZ(e)}},{key:"opROL_Sub",value:function(t){var e=t<<1|(this.p.isC()?1:0);return this.updateN(e),this.updateZ(e),this.updateC(e),255&e}},{key:"opROL",value:function(t){this.store(t,this.opROL_Sub(this.load(t)))}},{key:"opROR_Sub",value:function(t){var e=t>>1|(this.p.isC()?128:0);return this.updateN(e),this.updateZ(e),0==(1&t)?this.p.clearC():this.p.setC(),255&e}},{key:"opROR",value:function(t){this.store(t,this.opROR_Sub(this.load(t)))}},{key:"opSBC",value:function(t){var e=this.a.load(),i=this.load(t),n=this.p.isC()?0:1,s=e-i-n;this.a.store(s),this.updateN(s),this.updateZ(s),e>=i+n?this.p.setC():this.p.clearC(),128&(e^s)&&128&(e^i)?this.p.setV():this.p.clearV()}},{key:"opPHA",value:function(){this.pushStack(this.a.load())}},{key:"opPHP",value:function(){this.pushStack(this.p.load())}},{key:"opPLA",value:function(){var t=this.popStack();this.a.store(t),this.updateN(t),this.updateZ(t)}},{key:"opPLP",value:function(){this.p.store(this.popStack())}},{key:"opJMP",value:function(t){this.pc.store(t)}},{key:"opJSR",value:function(t){this.pc.decrement(),this.pushStack2Bytes(this.pc.load()),this.pc.store(t)}},{key:"opRTS",value:function(){this.pc.store(this.popStack2Bytes()),this.pc.increment()}},{key:"opRTI",value:function(){this.p.store(this.popStack()),this.pc.store(this.popStack2Bytes())}},{key:"opBranch",value:function(t,e){e&&this.pc.add(t)}},{key:"opBRK",value:function(){this.pc.increment(),this.p.setA(),this.p.setB(),this.interrupt(T)}},{key:"dump",value:function(){var t="cpu ",e=this.load(this.pc.load()),i=this.decode(e);return t+="p:"+this.p.dump()+" ",t+="pc:"+this.pc.dump()+" ",t+="sp:"+this.sp.dump()+" ",t+="a:"+this.a.dump()+" ",t+="x:"+this.x.dump()+" ",t+="y:"+this.y.dump()+" ",(t+=this.dump_cpu_op(i,e))+"\n"}},{key:"dump_cpu_op",value:function(t,e){var i="opc=(0x"+c(e)+"): ";return i+=t.instruction.name+" ",null!=t.mode&&(i+=t.mode.name),i+" "}},{key:"dump_cpu_memory",value:function(){for(var t=new A(65536),e=0;e<65536;e++)t.store(e,this.load(e));return t.dump()}}]),t}(),w=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&L(t,e)}(s,t);var e,i,n=(e=s,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,n=P(e);if(i){var s=P(this).constructor;t=Reflect.construct(n,arguments,s)}else t=n.apply(this,arguments);return g(this,t)});function s(){var t;return C(this,s),(t=n.call(this)).isCpuStatusRegister=!0,t.N_BIT=7,t.V_BIT=6,t.A_BIT=5,t.B_BIT=4,t.D_BIT=3,t.I_BIT=2,t.Z_BIT=1,t.C_BIT=0,t}return V(s,[{key:"isN",value:function(){return this.isBitSet(this.N_BIT)}},{key:"setN",value:function(){this.setBit(this.N_BIT)}},{key:"clearN",value:function(){this.clearBit(this.N_BIT)}},{key:"isV",value:function(){return this.isBitSet(this.V_BIT)}},{key:"setV",value:function(){this.setBit(this.V_BIT)}},{key:"clearV",value:function(){this.clearBit(this.V_BIT)}},{key:"isA",value:function(){return this.IsBitSet(this.A_BIT)}},{key:"setA",value:function(){this.setBit(this.A_BIT)}},{key:"clearA",value:function(){this.clearBit(this.A_BIT)}},{key:"isB",value:function(){return this.isBitSet(this.B_BIT)}},{key:"setB",value:function(){this.setBit(this.B_BIT)}},{key:"clearB",value:function(){this.clearBit(this.B_BIT)}},{key:"isD",value:function(){return this.isBitSet(this.D_BIT)}},{key:"setD",value:function(){this.setBit(this.D_BIT)}},{key:"clearD",value:function(){this.clearBit(this.D_BIT)}},{key:"isI",value:function(){return this.isBitSet(this.I_BIT)}},{key:"setI",value:function(){this.setBit(this.I_BIT)}},{key:"clearI",value:function(){this.clearBit(this.I_BIT)}},{key:"isZ",value:function(){return this.isBitSet(this.Z_BIT)}},{key:"setZ",value:function(){this.setBit(this.Z_BIT)}},{key:"clearZ",value:function(){this.clearBit(this.Z_BIT)}},{key:"isC",value:function(){return this.isBitSet(this.C_BIT)}},{key:"setC",value:function(){this.setBit(this.C_BIT)}},{key:"clearC",value:function(){this.clearBit(this.C_BIT)}},{key:"dump",value:function(){var t="";return t+=I.prototype.dump.call(this),t+="(",t+=this.isN()?"N":"-",t+=this.isV()?"V":"-",t+=this.isB()?"B":"-",t+=this.isD()?"D":"-",t+=this.isI()?"I":"-",t+=this.isZ()?"Z":"-",(t+=this.isC()?"C":"-")+")"}}]),s}(I);function X(t){return X="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},X(t)}function Z(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function U(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function x(t,e,i){return e&&U(t.prototype,e),i&&U(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function Y(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&G(t,e)}function G(t,e){return G=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},G(t,e)}function H(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var i,n=F(t);if(e){var s=F(this).constructor;i=Reflect.construct(n,arguments,s)}else i=n.apply(this,arguments);return j(this,i)}}function j(t,e){if(e&&("object"===X(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function F(t){return F=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},F(t)}var z=[4285887861,4287568679,4289396736,4288610375,4285989007,4279435435,4278190247,4278193023,4278202179,4278208256,4278210816,4279713536,4284432155,4278190080,4278190080,4278190080,4290559164,4293882624,4293868323,4294115459,4290707647,4284154087,4278201307,4279193547,4278219659,4278228736,4278233856,4282094336,4287333120,4278190080,4278190080,4278190080,4294967295,4294950719,4294940511,4294806439,4294933495,4290213887,4284708863,4282096639,4282367987,4279489411,4283162447,4288215128,4292602624,4278190080,4278190080,4278190080,4294967295,4294961067,4294956999,4294953943,4294952959,4292593663,4289970175,4289453055,4288931839,4288937955,4290769835,4291821491,4294180767,4278190080,4278190080,4278190080],K=function(t){Y(i,t);var e=H(i);function i(){var t;return Z(this,i),(t=e.call(this)).isPpuControlRegister=!0,t.NMI_VBLANK_BIT=7,t.MASTER_SLAVE_BIT=6,t.SPRITES_SIZE_BIT=5,t.BACKGROUND_PATTERN_TABLE_BIT=4,t.SPRITES_PATTERN_TABLE_BIT=3,t.INCREMENT_ADDRESS_BIT=2,t.NAME_TABLE_ADDRESS_BIT=0,t.NAME_TABLE_ADDRESS_BITS_WIDTH=2,t}return x(i,[{key:"isIncrementAddressSet",value:function(){return this.isBitSet(this.INCREMENT_ADDRESS_BIT)}},{key:"enabledNmi",value:function(){return this.isBitSet(this.NMI_VBLANK_BIT)}},{key:"isSpriteSize16",value:function(){return this.isBitSet(this.SPRITES_SIZE_BIT)}},{key:"getBackgroundPatternTableNum",value:function(){return this.loadBit(this.BACKGROUND_PATTERN_TABLE_BIT)}},{key:"getSpritesPatternTableNum",value:function(){return this.loadBit(this.SPRITES_PATTERN_TABLE_BIT)}},{key:"getNameTableAddress",value:function(){return this.loadBits(this.NAME_TABLE_ADDRESS_BIT,this.NAME_TABLE_ADDRESS_BITS_WIDTH)}}]),i}(I),q=function(t){Y(i,t);var e=H(i);function i(){var t;return Z(this,i),(t=e.call(this)).isPpuMaskRegister=!0,t.GREYSCALE_BIT=0,t.LEFTMOST_BACKGROUND_VISIBLE_BIT=1,t.LEFTMOST_SPRITES_VISIBLE_BIT=2,t.BACKGROUND_VISIBLE_BIT=3,t.SPRITES_VISIBLE_BIT=4,t.EMPHASIZE_RED_BIT=5,t.EMPHASIZE_GREEN_BIT=6,t.EMPHASIZE_BLUE_BIT=7,t}return x(i,[{key:"isGreyscale",value:function(){return this.isBitSet(this.GREYSCALE_BIT)}},{key:"isLeftMostBackgroundVisible",value:function(){return this.isBitSet(this.LEFTMOST_BACKGROUND_VISIBLE_BIT)}},{key:"isLeftMostSpritesVisible",value:function(){return this.isBitSet(this.LEFTMOST_SPRITES_VISIBLE_BIT)}},{key:"isBackgroundVisible",value:function(){return this.isBitSet(this.BACKGROUND_VISIBLE_BIT)}},{key:"isSpritesVisible",value:function(){return this.isBitSet(this.SPRITES_VISIBLE_BIT)}},{key:"emphasisRed",value:function(){return this.isBitSet(this.EMPHASIZE_RED_BIT)}},{key:"emphasisGreen",value:function(){return this.isBitSet(this.EMPHASIZE_GREEN_BIT)}},{key:"emphasisBlue",value:function(){return this.isBitSet(this.EMPHASIZE_BLUE_BIT)}}]),i}(I),W=function(t){Y(i,t);var e=H(i);function i(){var t;return Z(this,i),(t=e.call(this)).isPpuStatusRegister=!0,t.VBLANK_BIT=7,t.SPRITE_ZERO_HIT_BIT=6,t.SPRITE_OVERFLOW_BIT=5,t.VRAM_SHOULD_BE_IGNORE=4,t}return x(i,[{key:"setVBlank",value:function(){this.setBit(this.VBLANK_BIT)}},{key:"clearVBlank",value:function(){this.clearBit(this.VBLANK_BIT)}},{key:"setZeroHit",value:function(){this.setBit(this.SPRITE_ZERO_HIT_BIT)}},{key:"clearZeroHit",value:function(){this.clearBit(this.SPRITE_ZERO_HIT_BIT)}},{key:"setOverflow",value:function(){this.setBit(this.SPRITE_OVERFLOW_BIT)}},{key:"clearOverflow",value:function(){this.clearBit(this.SPRITE_OVERFLOW_BIT)}}]),i}(I);function J(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var Q=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.isPpu=!0,this.nes=e,this.rom=null,this.cpu=null,this.display=null,this.frame=0,this.scanLine=0,this.cycle=0,this.PALETTES=z,this.vRam=new A(16384),this.oamRam=new A(256),this.oamRam2=new A(32),this.ppuctrl=new K,this.ppumask=new q,this.ppustatus=new W,this.oamaddr=new I,this.oamdata=new I,this.ppuscroll=new I,this.ppuaddr=new I,this.ppudata=new I,this.oamdma=new I,this.name_table_baddr=0,this.ppuscroll_horizontal=0,this.ppuscroll_vertical=0,this.ppuscroll_1st_access=!0,this.ppuaddr_1st_access=!0,this.nameTableRegister=new I,this.attributeTableLowRegister=new _,this.attributeTableHighRegister=new _,this.patternTableLowRegister=new _,this.patternTableHighRegister=new _,this.nameTableLatch=0,this.attributeTableLowLatch=0,this.attributeTableHighLatch=0,this.patternTableLowLatch=0,this.patternTableHighLatch=0,this.fineXScroll=0,this.currentVRamAddress=0,this.temporalVRamAddress=0,this.vRamReadBuffer=0,this.registerFirstStore=!0,this.spritePixels=[],this.spriteIds=[],this.spritePriorities=[];for(var i=0;i<256;i++)this.spritePixels[i]=-1,this.spriteIds[i]=-1,this.spritePriorities[i]=-1}var e,i;return e=t,(i=[{key:"SetRom",value:function(t){this.rom=t}},{key:"SetCpu",value:function(t){this.cpu=t}},{key:"SetDisplay",value:function(t){this.display=t}},{key:"InitPpu",value:function(){this.ppustatus.store(128),this.vRam.clear()}},{key:"runCycle",value:function(){this.renderPixel(),this.shiftRegisters(),this.fetch(),this.updateFlags(),this.countUpScrollCounters(),this.countUpCycle()}},{key:"loadRegister",value:function(t){var e;switch(t){case 8192:case 8193:case 8195:case 8197:case 8198:return 0;case 8194:return e=this.ppustatus.load(),this.ppustatus.clearVBlank(),this.registerFirstStore=!0,e;case 8196:return this.oamRam.load(this.oamaddr.load());case 8199:return(16383&this.currentVRamAddress)>=0&&(16383&this.currentVRamAddress)<16128?(e=this.vRamReadBuffer,this.vRamReadBuffer=this.load(this.currentVRamAddress)):(e=this.load(this.currentVRamAddress),this.vRamReadBuffer=e),this.incrementVRamAddress(),e;default:console.error("this register("+t+") is not implemented.")}return 0}},{key:"storeRegister",value:function(t,e){switch(t){case 8192:this.ppuctrl.store(e),this.temporalVRamAddress&=-3073,this.temporalVRamAddress|=(3&e)<<10;break;case 8193:this.ppumask.store(e);break;case 8195:this.oamaddr.store(e);break;case 8196:this.oamdata.store(e),this.oamRam.store(this.oamaddr.load(),e),this.oamaddr.increment();break;case 8197:this.ppuscroll.store(e),!0===this.registerFirstStore?(this.fineXScroll=7&e,this.temporalVRamAddress&=-32,this.temporalVRamAddress|=e>>3&31):(this.temporalVRamAddress&=-29665,this.temporalVRamAddress|=(248&e)<<2,this.temporalVRamAddress|=(7&e)<<12),this.registerFirstStore=!this.registerFirstStore;break;case 8198:!0===this.registerFirstStore?(this.temporalVRamAddress&=-32513,this.temporalVRamAddress|=(63&e)<<8):(this.ppuaddr.store(e),this.temporalVRamAddress&=-256,this.temporalVRamAddress|=255&e,this.currentVRamAddress=this.temporalVRamAddress),this.registerFirstStore=!this.registerFirstStore;break;case 8199:this.ppudata.store(e),this.store(this.currentVRamAddress,e),this.incrementVRamAddress();break;default:console.error("this register("+t+") is not implemented.")}}},{key:"load",value:function(t){return(t&=16383)<8192&&!0===this.rom.hasChrRom()?this.rom.load(t):t>=8192&&t<16128?this.vRam.load(this.getNameTableAddressWithMirroring(12287&t)):(t>=16128&&t<16384&&(t&=16159),16144===t&&(t=16128),16148===t&&(t=16132),16152===t&&(t=16136),16156===t&&(t=16140),this.vRam.load(t))}},{key:"store",value:function(t,e){if((t&=16383)<8192&&!0===this.rom.hasChrRom())this.rom.store(t,e);else{if(!(t>=8192&&t<16128))return t>=16128&&t<16384&&(t&=16159),16144===t&&(t=16128),16148===t&&(t=16132),16152===t&&(t=16136),16156===t&&(t=16140),this.vRam.store(t,e);this.vRam.store(this.getNameTableAddressWithMirroring(12287&t),e)}}},{key:"getNameTableAddressWithMirroring",value:function(t){t&=12287;var e=0;switch(this.rom.getMirroringType()){case 0:e=8192;break;case 1:e=t>=8192&&t<9216||t>=9216&&t<10240?8192:9216;break;case 2:e=t>=8192&&t<9216?8192:t>=9216&&t<10240?9216:t>=10240&&t<11264?8192:9216;break;case 3:e=t>=8192&&t<9216?8192:t>=9216&&t<10240?9216:t>=10240&&t<11264?10240:11264}return e|1023&t}},{key:"renderPixel",value:function(){if(!(this.cycle>=257||this.scanLine>=240||0===this.cycle)){var t=this.cycle-1,e=this.scanLine,i=this.ppumask.isBackgroundVisible(),n=this.ppumask.isSpritesVisible(),s=this.getBackgroundPixel(),r=this.spritePixels[t],c=this.spriteIds[t],o=this.spritePriorities[t],a=this.PALETTES[this.load(16128)];!0===i&&!0===n?a=-1===r?s:s===a||0===o?r:s:!0===i&&!1===n?a=s:!1===i&&!0===n&&-1!==r&&(a=r),!0===this.ppumask.emphasisRed()&&(a|=16711680),!0===this.ppumask.emphasisGreen()&&(a|=65280),!0===this.ppumask.emphasisBlue()&&(a|=255),!0===i&&!0===n&&0===c&&0!==r&&0!==s&&this.ppustatus.setZeroHit(),this.display.renderPixel(t,e,a)}}},{key:"getBackgroundPixel",value:function(){var t=15-this.fineXScroll,e=this.patternTableHighRegister.loadBit(t)<<1|this.patternTableLowRegister.loadBit(t),i=(this.attributeTableHighRegister.loadBit(t)<<1|this.attributeTableLowRegister.loadBit(t))<<2|e;return!0===this.ppumask.isGreyscale()&&(i&=48),this.PALETTES[this.load(16128+i)]}},{key:"shiftRegisters",value:function(){this.scanLine>=240&&this.scanLine<=260||(this.cycle>=1&&this.cycle<=256||this.cycle>=329&&this.cycle<=336)&&(this.patternTableLowRegister.shift(0),this.patternTableHighRegister.shift(0),this.attributeTableLowRegister.shift(0),this.attributeTableHighRegister.shift(0))}},{key:"fetch",value:function(){if(!(this.scanLine>=240&&this.scanLine<=260||0===this.cycle||this.cycle>=257&&this.cycle<=320||this.cycle>=337)){switch((this.cycle-1)%8){case 0:this.fetchNameTable();break;case 2:this.fetchAttributeTable();break;case 4:this.fetchPatternTableLow();break;case 6:this.fetchPatternTableHigh()}this.cycle%8==1&&(this.nameTableRegister.store(this.nameTableLatch),this.attributeTableLowRegister.storeLowerByte(this.attributeTableLowLatch),this.attributeTableHighRegister.storeLowerByte(this.attributeTableHighLatch),this.patternTableLowRegister.storeLowerByte(this.patternTableLowLatch),this.patternTableHighRegister.storeLowerByte(this.patternTableHighLatch))}}},{key:"fetchNameTable",value:function(){this.nameTableLatch=this.load(8192|4095&this.currentVRamAddress)}},{key:"fetchAttributeTable",value:function(){var t=this.currentVRamAddress,e=9152|3072&t|t>>4&56|t>>2&7,i=this.load(e)>>((((t>>5&31)%4>=2?1:0)<<1|((31&t)%4>=2?1:0))<<1)&3,n=i>>1,s=1&i;this.attributeTableHighLatch=1===n?255:0,this.attributeTableLowLatch=1===s?255:0}},{key:"fetchPatternTableLow",value:function(){var t=this.currentVRamAddress>>12&7,e=4096*this.ppuctrl.getBackgroundPatternTableNum()+16*this.nameTableRegister.load()+t;this.patternTableLowLatch=this.load(e)}},{key:"fetchPatternTableHigh",value:function(){var t=this.currentVRamAddress>>12&7,e=4096*this.ppuctrl.getBackgroundPatternTableNum()+16*this.nameTableRegister.load()+t;this.patternTableHighLatch=this.load(e+8)}},{key:"updateFlags",value:function(){1===this.cycle&&(241===this.scanLine?(this.ppustatus.setVBlank(),this.display.updateScreen(),!0===this.ppuctrl.enabledNmi()&&this.cpu.interrupt(b)):261===this.scanLine&&(this.ppustatus.clearVBlank(),this.ppustatus.clearZeroHit(),this.ppustatus.clearOverflow())),10===this.cycle&&241===this.scanLine&&!0===this.ppuctrl.enabledNmi()&&this.cpu.interrupt(b),!0===this.rom.mapper.isMMC3Mapper&&340===this.cycle&&this.scanLine<=240&&!0===this.ppumask.isBackgroundVisible()&&!0===this.ppumask.isSpritesVisible()&&this.rom.mapper.driveIrqCounter(this.cpu)}},{key:"countUpScrollCounters",value:function(){if((!1!==this.ppumask.isBackgroundVisible()||!1!==this.ppumask.isSpritesVisible())&&!(this.scanLine>=240&&this.scanLine<=260||(261===this.scanLine&&this.cycle>=280&&this.cycle<=304&&(this.currentVRamAddress&=-31713,this.currentVRamAddress|=31712&this.temporalVRamAddress),0===this.cycle||this.cycle>=258&&this.cycle<=320))){if(this.cycle%8==0){var t=this.currentVRamAddress;31==(31&t)?(t&=-32,t^=1024):t++,this.currentVRamAddress=t}if(256===this.cycle){var e=this.currentVRamAddress;if(28672!=(28672&e))e+=4096;else{var i=(992&(e&=-28673))>>5;29===i?(i=0,e^=2048):31===i?i=0:i++,e=-993&e|i<<5}this.currentVRamAddress=e}257===this.cycle&&(this.currentVRamAddress&=-1056,this.currentVRamAddress|=1055&this.temporalVRamAddress)}}},{key:"countUpCycle",value:function(){this.cycle++,this.cycle>340&&(this.cycle=0,this.scanLine++,this.scanLine>261&&(this.scanLine=0,this.frame++))}},{key:"incrementVRamAddress",value:function(){this.currentVRamAddress+=this.ppuctrl.isIncrementAddressSet()?32:1,this.currentVRamAddress&=32767,this.ppuaddr.store(255&this.currentVRamAddress)}},{key:"dump",value:function(){var t="";return t+="PPU Ctrl: "+this.ppuctrl.dump()+"\n",t+="PPU Mask: "+this.ppumask.dump()+"\n",t+="PPU Status: "+this.ppustatus.dump()+"\n",t+="OAM Address: "+this.oamaddr.dump()+"\n",t+="OAM Data: "+this.oamdata.dump()+"\n",t+="PPU Scroll: "+this.ppuscroll.dump()+"\n",t+="PPU Addr: "+this.ppuaddr.dump()+"\n",t+="PPU Data: "+this.ppudata.dump()+"\n",(t+="OAM DMA: "+this.oamdma.dump()+"\n")+"\n"}},{key:"dump_ppu_memory",value:function(){for(var t=new A(16384),e=0;e<16384;e++)t.store(e,this.load(e));return t.dump()}},{key:"dumpVRAM",value:function(){for(var t=new A(65536),e=0;e<16384;e++)t.store(e,this.load(e));return t.dump()}}])&&J(e.prototype,i),Object.defineProperty(e,"prototype",{writable:!1}),t}();function $(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var tt={0:{name:"NROM"},1:{name:"MMC1"},2:{name:"UNROM"},3:{name:"CNROM"},4:{name:"MMC3"},76:{name:"Mapper76"}},et=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.isMapper=!0,this.rom=e,this.prgBankNum=e.header_parse.prg_bank_num,this.chrBankNum=e.header_parse.chr_bank_num,this.mapper_num=e.header_parse.mapper_num}var e,i;return e=t,(i=[{key:"getName",value:function(){return this.getMapperParam(this.mapper_num).name}},{key:"getMapperParam",value:function(t){if(void 0===tt[t])throw new Error("unsupport No."+t+" Mapper");return tt[t]}},{key:"map",value:function(t){return 1===this.prgBankNum&&t>=49152&&(t-=16384),t-32768}},{key:"mapForChrRom",value:function(t){return t}},{key:"store",value:function(t,e){console.log("Mapper.store(not work): ".concat(e," to ").concat(t))}},{key:"getMirroringType",value:function(){return this.rom.header_parse.screen_type}}])&&$(e.prototype,i),Object.defineProperty(e,"prototype",{writable:!1}),t}();function it(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var nt=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.isRom=!0,this.nes=e,this.data=null,this.size=0,this.header=null,this.header_parse=null,this.mapper=null}var e,i;return e=t,(i=[{key:"SetRom",value:function(t){this.data=new A(t),this.size=this.data.getCapacity(),console.log("[Rom.SetRom] data size : "+this.size),this.header=new A(16);for(var e=0;e<16;e++)this.header.data[e]=this.data.load(e);return!!this._isNes()&&(this.header_parse=this._ParseHeader(this.header),this.mapper=new et(this),console.log("Mapper Num : "+this.header_parse.mapper_num+" ("+this.mapper.getName()+")"),!0)}},{key:"_isNes",value:function(){return"NES"!==[].slice.call(this.header.data,0,3).map((function(t){return String.fromCharCode(t)})).join("")?(console.error("This file is not NES format."),!1):(console.log("This file is NES format."),console.log(this.header),!0)}},{key:"_ParseHeader",value:function(t){if(null!==t){var e={header_size:16};return e.prg_bank_num=t.load(4),e.chr_bank_num=t.load(5),e.isHorizontalMirror=!(1&t.load(6)),e.isPresenceBatteryRAM=!!(2&t.load(6)),e.isPresenceTrainer=!!(4&t.load(6)),e.isFourScreenMirror=!!(8&t.load(6)),e.mapper_num=(240&t.load(6))>>4|240&this.header.load(7),e.screen_type=0,e.isFourScreenMirror?e.screen_type=3:e.isHorizontalMirror?e.screen_type=1:e.screen_type=2,e}}},{key:"load",value:function(t){var e=this.header_parse.header_size;return t<8192?(e+=16384*this.header_parse.prg_bank_num,e+=this.mapper.mapForChrRom(t)):e+=this.mapper.map(t),this.data.load(e)}},{key:"store",value:function(t,e){this.mapper.store(255&t,e)}},{key:"hasChrRom",value:function(){return this.header_parse.chr_bank_num>0}},{key:"getMirroringType",value:function(){return this.header_parse.screen_type}},{key:"dump",value:function(){return this.data.dump()}},{key:"header_dump",value:function(){return this.header.dump()}},{key:"header_info",value:function(){var t="";switch(t+="PRG-ROM banks size: "+16*this.header_parse.prg_bank_num+"(KB)\n",t+="CHR-ROM banks size: "+8*this.header_parse.chr_bank_num+"(KB)\n",t+="mapper number : "+this.header_parse.mapper_num+"\n",t+="screen type   : ",this.header_parse.screen_type){case 1:t+="HORIZONTAL";break;case 2:t+="VERTICAL";break;case 3:t+="FOUR_SCREEN";break;default:t+="SINGLE_SCREEN"}return t+"\n\n"}}])&&it(e.prototype,i),Object.defineProperty(e,"prototype",{writable:!1}),t}();function st(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var rt=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.isNes=!0,this.display=new n(e),this.cpu=new M(this),this.ppu=new Q(this),this.rom=new nt(this),this.cpu.SetPpu(this.ppu),this.ppu.SetCpu(this.cpu),this.ppu.SetDisplay(this.display),this.cycle=0,this.cycle_limit=16}var e,i;return e=t,(i=[{key:"SetRom",value:function(t){return!!this.rom.SetRom(t)&&(this.cpu.SetRom(this.rom),this.ppu.SetRom(this.rom),this.rom)}},{key:"Init",value:function(){this.cpu.InitCpu(),this.ppu.InitPpu(),this.cycle=0,this.cycle_limit=16}},{key:"Run",value:function(){for(var t=0|Math.floor(89342/3);this.cycle<this.cycle_limit;)this.runCycle(),this.cycle++,this.cycle%t==0&&console.log("update display. at cycle = "+this.cycle);this.cycle===this.cycle_limit&&(console.log("NES reach to limit. cycle : "+this.cycle),this.cpu.dbg_message=!0)}},{key:"runCycle",value:function(){this.cpu.runCycle(),this.ppu.runCycle(),this.ppu.runCycle(),this.ppu.runCycle()}}])&&st(e.prototype,i),Object.defineProperty(e,"prototype",{writable:!1}),t}();function ct(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var ot,at,ut,lt,dt=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.area=e,this.clrMessage(),this.putMessage("add dump console..")}var e,i;return e=t,(i=[{key:"putMessage",value:function(t){console.log(t),this.area.value+=t+"\n",this.area.scrollTop=this.area.scrollHeight}},{key:"clrMessage",value:function(){this.area.value=""}}])&&ct(e.prototype,i),Object.defineProperty(e,"prototype",{writable:!1}),t}();function ht(t){lt.putMessage("Rom load..."),ut.SetRom(t)?(lt.putMessage("Header is "),lt.putMessage(ut.rom.header_dump()),lt.putMessage(ut.rom.header_info()),ut.Init(),lt.putMessage("NES Init..."),lt.putMessage(ut.cpu.dump()),lt.putMessage(ut.ppu.dump()),ut.Run(),lt.putMessage("after Run.")):console.error("Can't get rom data (perhaps you don't set ArrayBuffer arguments or it's not nes rom format)")}document.addEventListener("DOMContentLoaded",(function(){ot=document.querySelector("#NESdisplay"),ut=new rt(ot),window.nes=ut,ut.display.resizeCanvas(),void 0!==window.FileReader&&(window.addEventListener("dragenter",(function(t){t.preventDefault()}),!1),window.addEventListener("dragover",(function(t){t.preventDefault()}),!1),window.addEventListener("drop",(function(t){t.preventDefault(),function(t,e){lt.putMessage("read filename is "+t.name);var i=new FileReader;i.onload=function(t){e(t.target.result)},i.readAsArrayBuffer(t)}(t.dataTransfer.files[0],ht)}),!1),document.getElementById("romload").addEventListener("click",(function(t){t.preventDefault(),function(t,e){lt.putMessage("rom url is "+t);var i=new XMLHttpRequest;i.onload=function(){e(i.response)},i.onerror=function(t){console.error("can't get rom binary. Error is ",t)},i.open("GET",t,!0),i.responseType="arraybuffer",i.send(null)}(document.getElementById("romlist").value,ht)}),!1),document.querySelector("#nes_reset").addEventListener("click",(function(t){t.preventDefault(),lt.clrMessage(),lt.putMessage("NES Reset...\n"),ut.Init(),lt.putMessage(ut.cpu.dump()),lt.putMessage(ut.ppu.dump()),ut.Run()}),!1),document.querySelector("#nes_step").addEventListener("click",(function(t){t.preventDefault(),lt.putMessage("#Step +1cycles"),ut.cycle_limit+=1,ut.Run()}),!1),document.querySelector("#nes_step16").addEventListener("click",(function(t){t.preventDefault(),lt.putMessage("\n#Step +16cycles"),ut.cycle_limit+=16,ut.Run()}),!1),document.querySelector("#nes_step16K").addEventListener("click",(function(t){t.preventDefault(),lt.putMessage("\n#Step +16 * 1024cycles"),ut.cycle_limit+=16384,ut.cpu.dbg_message=!1,ut.Run()}),!1),document.querySelector("#clear_console").addEventListener("click",(function(t){t.preventDefault(),lt.clrMessage(),lt.putMessage("clear message...\n")}),!1),document.querySelector("#dump_rom").addEventListener("click",(function(t){t.preventDefault(),lt.putMessage("\n\n# Dump ROM data"),lt.putMessage(ut.rom.dump())}),!1),document.querySelector("#dump_cpuppu_reg").addEventListener("click",(function(t){t.preventDefault(),lt.putMessage("\n# Dump CPU/PPU Registers"),lt.putMessage(ut.cpu.dump()),lt.putMessage(ut.ppu.dump())}),!1),document.querySelector("#dump_cpumem").addEventListener("click",(function(t){t.preventDefault(),lt.putMessage("\n# Dump CPU Memory"),lt.putMessage(ut.cpu.dump_cpu_memory())}),!1),document.querySelector("#dump_ppumem").addEventListener("click",(function(t){t.preventDefault(),lt.putMessage("\n# Dump PPU Memory"),lt.putMessage(ut.ppu.dump_ppu_memory())}),!1),document.querySelector("#dump_ppuvram").addEventListener("click",(function(t){t.preventDefault(),lt.putMessage("\n# Dump PPU VRAM"),lt.putMessage(ut.ppu.dumpVRAM())}),!1)),window.addEventListener("resize",(function(){ut.display.resizeCanvas()})),at=document.querySelector("#DBGconsole"),lt=new dt(at),window.dump=lt}))})();